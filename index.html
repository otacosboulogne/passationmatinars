<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CONTR√îLE PASSATION MIDI</title>
  <style>
    :root{
      --ink:#111; --muted:#666; --line:#1a1a1a; --bg:#fff; --accent:#000;
      --ok-bg:#e8f5e9; --ok-accent:#2e7d32;
      --todo-bg:#ffebee; --todo-accent:#c62828;
      --passation-bg:#e8f5e9;
    }
    html,body{height:100%}
    body{font-family:Arial,Helvetica,sans-serif;color:var(--ink);background:var(--bg);margin:0}

    .page{max-width:980px;margin:24px auto;padding:24px;background:var(--passation-bg);border-radius:10px}
    h1{text-align:center;font-size:24px;margin:0 0 18px}

    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}

    .block{background:#fff;border:2px solid var(--line);border-radius:6px;padding:10px 10px 6px;page-break-inside:avoid}
    .block h2{font-size:16px;margin:0 0 8px;text-transform:uppercase;letter-spacing:.5px}

    /* Tableaux des checklists */
    table.check{border-collapse:collapse;width:100%;font-size:13px;color:var(--ink)}
    table.check th,table.check td{border:1px solid #ccc;padding:6px 8px;vertical-align:top;background:#fff}
    table.check th{background:#f2f2f2;font-weight:700;text-align:left}
    table.check th:nth-child(2),table.check th:nth-child(3){width:72px;text-align:center}
    table.check td:nth-child(2),table.check td:nth-child(3){text-align:center}
    .head-todo{background:var(--todo-bg)!important;color:var(--todo-accent);border-color:var(--todo-accent)!important}
    .head-ok{background:var(--ok-bg)!important;color:var(--ok-accent);border-color:var(--ok-accent)!important}
    .is-todo td{background:var(--todo-bg)} .is-ok td{background:var(--ok-bg)}
    .is-required td:first-child,.is-required td:first-child *{color:var(--todo-accent)!important;font-weight:700}

    .notes{margin-top:16px;border:2px solid var(--line);border-radius:6px;padding:10px;background:#fff}
    .notes h3{margin:0 0 6px;font-size:14px;text-transform:uppercase}
    .notes textarea{width:100%;min-height:90px;border:1px solid #ccc;border-radius:4px;padding:8px;font-family:inherit;font-size:13px}

    .flex{display:flex;gap:12px;flex-wrap:wrap}
    .flex .field{flex:1 1 220px}
    .field label{display:block;font-size:12px;color:#333;margin:8px 0 4px}
    .field input,.field textarea,.field select{width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;font-size:13px}

    .radio-row{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
    .radio-row label{display:flex;align-items:center;gap:6px;font-size:13px;margin:0}

    /* Tableau REPAS SANS BORDURES */
    .repas-table{border-collapse:collapse;width:100%;margin-top:6px;border:none}
    .repas-table th,.repas-table td{border:none;padding:6px 8px;vertical-align:middle;background:#fff}
    .repas-table thead th{background:transparent;font-weight:600;text-align:left;border-bottom:2px solid #ccc}
    .repas-table td.center{text-align:center}

    .submitbar{display:flex;gap:12px;align-items:center;justify-content:flex-end;margin-top:18px}
    button[type="submit"]{background:#111;color:#fff;border:none;border-radius:6px;padding:10px 16px;font-weight:700;cursor:pointer}
    button[type="reset"]{display:none!important}
    input[disabled]{opacity:.35;cursor:not-allowed}

    @media print{
      body{background:#fff}
      .page{margin:0;padding:0;background:#fff}
      .submitbar{display:none}
      a[href]:after{content:""}
    }
  </style>
</head>
<body>
  <div class="page">
    <h1>CONTR√îLE PASSATION MIDI</h1>

    <form id="passationForm">
      <div class="grid" id="sections"></div>

      <div class="notes">
        <h3>Commentaires & informations</h3>
        <div class="flex">
          <div class="field" style="flex:1 1 100%">
            <label for="commentaires">Commentaires et informations diverses (Information importante / personnel / incident caisse / technique)</label>
            <textarea id="commentaires" name="commentaires" placeholder="Saisir ici..."></textarea>
          </div>
          <div class="field" style="flex:1 1 100%">
            <label for="ruptures">Pr√©ciser ici les prochaines ruptures</label>
            <textarea id="ruptures" name="ruptures" placeholder="Produits √† risque de rupture, quantit√©s restantes, etc..."></textarea>
          </div>
        </div>
      </div>

      <div class="footer">
        <div class="block">
          <h2>Informations importantes</h2>
          <div class="flex">
            <!-- Pertes + d√©tail dynamique -->
            <div class="field">
              <label for="nombrePertesConception">Nombre de pertes de conception en cuisine durant ton service</label>
              <input id="nombrePertesConception" name="nombrePertesConception" type="number" inputmode="numeric" min="0" step="1" placeholder="0" required>
              <div id="detailPertesConception" class="field" style="display:none;">
                <label for="detailsPertesConception">D√©tail des pertes de conception</label>
                <textarea id="detailsPertesConception" name="detailsPertesConception" placeholder="Pr√©cisez les produits ou erreurs..."></textarea>
              </div>
            </div>

            <!-- Repas employ√©s (dynamique) -->
            <div id="repas-employes" class="field repas-field" style="flex:1 1 420px;min-width:360px">
              <label>Repas employ√©s</label>
              <table class="repas-table" aria-label="Repas employ√©s">
                <colgroup>
                  <col style="width:50%"><col style="width:15%"><col style="width:15%"><col style="width:20%">
                </colgroup>
                <thead>
                  <tr>
                    <th>Nom du salari√©</th>
                    <th>Tacos</th>
                    <th>Finger Food</th>
                    <th>Supprimer</th>
                  </tr>
                </thead>
                <tbody id="repas-body">
                  <tr>
                    <td><input type="text" name="employe_nom_1" placeholder="Nom et pr√©nom" aria-label="Nom du salari√© 1"></td>
                    <td class="center"><input type="radio" name="employe_1_repas" value="tacos" aria-label="Tacos - salari√© 1"></td>
                    <td class="center"><input type="radio" name="employe_1_repas" value="finger" aria-label="Finger Food - salari√© 1"></td>
                    <td class="center"><button type="button" class="remove-row" style="background:#c62828;color:#fff;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;">üóëÔ∏è</button></td>
                  </tr>
                </tbody>
              </table>
              <button type="button" id="add-repas" style="margin-top:8px;background:#1565c0;color:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;">
                + Ajouter un repas
              </button>
              <p class="form-error" aria-live="polite"></p>
            </div>

            <!-- Radios infos -->
            <div class="field" style="flex:1 1 280px">
              <label>La commande sur Inpulse a √©t√© valid√©e</label>
              <div class="radio-row" role="radiogroup" aria-label="Commande valid√©e">
                <label><input type="radio" name="commandeValidee" value="Oui"> Oui</label>
                <label><input type="radio" name="commandeValidee" value="Non"> Non</label>
              </div>
            </div>
            <div class="field" style="flex:1 1 280px">
              <label>Le reporting a √©t√© rempli</label>
              <div class="radio-row" role="radiogroup" aria-label="Reporting rempli">
                <label><input type="radio" name="reportingRempli" value="Oui"> Oui</label>
                <label><input type="radio" name="reportingRempli" value="Non"> Non</label>
              </div>
            </div>
          </div>
        </div>

        <div class="block">
          <h2>Informations de passation</h2>
          <div class="flex">
            <div class="field"><label for="date">Date</label><input id="date" name="date" type="date" required></div>
            <div class="field"><label for="heure">Heure</label><input id="heure" name="heure" type="time" required></div>
            <div class="field" style="flex:1 1 280px"><label for="respUnique">Nom du responsable</label><input id="respUnique" name="responsable" type="text" required></div>
          </div>
        </div>
      </div>

      <div class="submitbar">
        <button type="submit">Envoyer la checklist</button>
      </div>
    </form>
  </div>

  <!-- ===== SCRIPTS ===== -->
  <script>
    /* --------- SECTIONS (checklists) --------- */
    const SECTIONS = [
      { title: "Terrasse", tasks: ["Sol, tables, chaises","Poubelle","Cendriers vides et disponibles"]},
      { title: "Toilettes Clients", tasks: ["Papier / savon","Toilettes (cuvette, lunette, rebords)","Odeur","Miroir","Poubelle propre et non pleine","S√®che-mains propre et fonctionnel"]},
      { title: "Cuisine", tasks: ["Viandes et suppl√©ments en suffisance","Sauces en suffisance","Frigo rempli","Essuie-mains, savon en suffisance","Poubelles chang√©es","Tra√ßabilit√© prise","Pertes comptabilis√©es","Galettes descendues","Rouleaux de papier dans imprimantes","Huile √† niveau dans les friteuses","Eau √† niveau dans bain-marie","Friteuses filtr√©es","Filtre friteuse chang√©","Emballages en suffisance","Sol et surfaces propres"]},
      { title: "Chambre froide et Frigos", tasks: ["D√©cong√©lations pr√©par√©es","Sauces en double dans meuble froid","Caillebotis propres","√âtag√®res propres","Produits remont√©s / rotation faite Ch- et frigos","Frigo 2 prtes et Frigo 1 porte propre (int/ext)"]},
      { title: "Salle", tasks: ["Sol propre","Tables, pieds de tables, chaises propres","Poubelles propres et non pleines","Musique en marche","Bornes fonctionnelles"]},
      { title: "Comptoir", tasks: ["Frigos √† boissons remplis","Comptoir desserts rempli","Toppings, nappages, lait en suffisance","T√©l√©commandes, agrafeuse, et t√©l√©phone disponibles","DLC contr√¥l√©es, signalement si besoin","Meuble O‚Äôsucr√© propre et rang√©","Comptoir propre et rang√©","Pr√©sence pailles/serviettes/gobelets/emballages","Plateaux propres et dress√©s","Machine √† glace propre","Vaisselle propre","Savon, essuie-mains en suffisance","Produits d‚Äôentretien en suffisance","Rouleaux pleins dans imprimantes et TPE","Caisse compt√©e + celle de l'√©quipier + fond de caisse fait si Glory en panne","Monnaie suffisante dans monnayeur (pr√©venir dans le groupe manager sinon)","Disponibilit√© produits en caisse / Borne / Uber (d√®s r√©ception apr√®s rupture)"]},
      { title: "R√©serves", tasks: ["R√©serve bien rang√©e","Sol et √©tag√®res propres","FIFO / DLC"]},
      { title: "√âtage", tasks: ["Sol propre","Toilettes, lavabos, murs propres","Savon, essuie-mains en suffisance","Poubelles non pleines"]},
      { title: "Plonge", tasks: ["Plonge termin√©e","Zone et mat√©riel propres","Produits diluer et en suffisance"]},
      { title: "E-Pack Hygi√®ne", tasks: ["Nettoyage des postes rempli","Check-list manager remplie"]},
      { title: "Tenue du personnel", tasks: ["Compl√®te, propre, repass√©e","Cheveux attach√©s","Pas de bijoux sauf alliance","Charlotte, tablier, sur-chaussures en cuisine"]}
    ];

    const OK_ONLY = new Map([
      ["Cuisine", new Set(["Viandes et suppl√©ments en suffisance","Sauces en suffisance","Essuie-mains, savon en suffisance","Galettes descendues","Rouleaux de papier dans imprimantes","Huile √† niveau dans les friteuses","Eau √† niveau dans bain-marie","Emballages en suffisance"])],
      ["Salle", new Set(["Bornes fonctionnelles"])],
      ["R√©serves", new Set(["FIFO / DLC"])],
      ["Plonge", new Set(["Produits diluer et en suffisance"])],
      ["Toilettes Clients", new Set(["Papier / savon"])],
      ["Chambre froide et Frigos", new Set(["D√©cong√©lations pr√©par√©es","Produits remont√©s / rotation faite Ch- et frigos"])],
      ["Comptoir", new Set(["Frigos √† boissons remplis","Comptoir desserts rempli","Toppings, nappages, lait en suffisance","DLC contr√¥l√©es, signalement si besoin","Plateaux propres et dress√©s","Rouleaux pleins dans imprimantes et TPE","Caisse compt√©e + celle de l'√©quipier + fond de caisse fait si Glory en panne","Disponibilit√© produits en caisse / Borne / Uber (d√®s r√©ception apr√®s rupture)")]],
      ["E-Pack Hygi√®ne", new Set(["Nettoyage des postes rempli","Check-list manager remplie"])],
      ["Tenue du personnel", new Set(["Charlotte, tablier, sur-chaussures en cuisine"])]
    ]);

    function isOkOnly(sectionTitle, taskText){
      return OK_ONLY.has(sectionTitle) && OK_ONLY.get(sectionTitle).has(taskText);
    }

    const sectionsRoot = document.getElementById('sections');

    function buildStandardBlock(section){
      const block = document.createElement('section'); block.className='block';
      const h = document.createElement('h2'); h.textContent = section.title.toUpperCase();

      const table = document.createElement('table'); table.className='check';
      const thead = document.createElement('thead');
      thead.innerHTML = `<tr><th>T√¢che</th><th class="head-todo">√Ä FAIRE</th><th class="head-ok">OK</th></tr>`;
      const tbody = document.createElement('tbody');

      section.tasks.forEach((task, tIdx) => {
        const id = `${section.title.replace(/[^a-z0-9]/gi,'_').toLowerCase()}_${tIdx}`;
        const onlyOk = isOkOnly(section.title, task);
        const tr = document.createElement('tr');
        if (onlyOk) tr.classList.add('is-required');
        tr.innerHTML = `
          <td>${task}</td>
          <td>${ onlyOk ? `<input type="radio" disabled title="Non disponible pour cette t√¢che">`
                         : `<input type="radio" name="${id}" value="A faire" aria-label="${task} - A faire">` }</td>
          <td><input type="radio" name="${id}" value="OK" aria-label="${task} - OK"></td>
        `;
        tr.addEventListener('change', (e) => {
          if(e.target.name === id){
            tr.classList.remove('is-todo','is-ok');
            if(e.target.value === 'A faire') tr.classList.add('is-todo');
            if(e.target.value === 'OK')      tr.classList.add('is-ok');
          }
        });
        tbody.appendChild(tr);
      });

      table.appendChild(thead); table.appendChild(tbody);
      block.appendChild(h); block.appendChild(table);
      return block;
    }

    function buildObjectifBlock(){
      const block = document.createElement('section'); block.className='block';
      const h = document.createElement('h2'); h.textContent = 'OBJECTIF';
      const table = document.createElement('table'); table.className='check';
      const thead = document.createElement('thead');
      thead.innerHTML = `<tr><th>√âl√©ment</th><th class="head-ok">Oui</th><th class="head-todo">Non</th></tr>`;
      const tbody = document.createElement('tbody');

      [
        { label: "Objectif avis Google donn√© au salari√© en caisse", name: "objectifAvisGoogle" },
        { label: "Briefing et d√©briefing effectu√©s", name: "briefingDebriefing" },
        { label: "Satisfait du service", name: "satisfaitService" }
      ].forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.label}</td>
          <td><input type="radio" name="${r.name}" value="Oui" aria-label="${r.label} - Oui"></td>
          <td><input type="radio" name="${r.name}" value="Non" aria-label="${r.label} - Non"></td>
        `;
        tbody.appendChild(tr);
      });

      table.appendChild(thead); table.appendChild(tbody);
      block.appendChild(h); block.appendChild(table);
      return block;
    }

    // G√©n√®re les sections + ins√®re OBJECTIF apr√®s "E-Pack Hygi√®ne"
    SECTIONS.forEach((section) => {
      const block = buildStandardBlock(section);
      sectionsRoot.appendChild(block);
      if (section.title === "E-Pack Hygi√®ne") sectionsRoot.appendChild(buildObjectifBlock());
    });

    /* --------- Interactions : pertes + repas --------- */
    document.addEventListener("DOMContentLoaded", () => {});
    const pertesInput = document.getElementById("nombrePertesConception");
    const detailField = document.getElementById("detailPertesConception");
    const detailTextarea = document.getElementById("detailsPertesConception");

    pertesInput.addEventListener("input", function(){
      const v = parseInt(pertesInput.value,10);
      if(!isNaN(v) && v > 0){
        detailField.style.display = "block";
        detailTextarea.setAttribute("required","required");
      }else{
        detailField.style.display = "none";
        detailTextarea.removeAttribute("required");
        detailTextarea.value = "";
      }
    });

    const repasBody = document.getElementById("repas-body");
    const addBtn    = document.getElementById("add-repas");
    const repasField= document.getElementById("repas-employes");
    const form      = document.getElementById("passationForm");
    let count = 1;

    addBtn.addEventListener("click", function(){
      count++;
      const row = document.createElement("tr");
      row.innerHTML = `
        <td><input type="text" name="employe_nom_${count}" placeholder="Nom et pr√©nom" aria-label="Nom du salari√© ${count}"></td>
        <td class="center"><input type="radio" name="employe_${count}_repas" value="tacos" aria-label="Tacos - salari√© ${count}"></td>
        <td class="center"><input type="radio" name="employe_${count}_repas" value="finger" aria-label="Finger Food - salari√© ${count}"></td>
        <td class="center"><button type="button" class="remove-row" style="background:#c62828;color:#fff;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;">üóëÔ∏è</button></td>
      `;
      repasBody.appendChild(row);
    });

    repasBody.addEventListener("click", function(e){
      if(e.target.classList.contains("remove-row")){
        const row = e.target.closest("tr");
        if (repasBody.querySelectorAll("tr").length > 1) row.remove();
        else alert("Il doit rester au moins une ligne !");
      }
    });

    // Validation : au moins une ligne repas valide (nom + radio)
    form.addEventListener("submit", function(e){
      const rows = repasBody.querySelectorAll("tr");
      let valid = false;
      for (let row of rows){
        const nom = row.querySelector('input[type="text"]').value.trim();
        const checked = row.querySelector('input[type="radio"]:checked');
        if (nom && checked){ valid = true; break; }
      }
      if (!valid){
        e.preventDefault();
        repasField.classList.add("error");
        const err = repasField.querySelector(".form-error");
        if (err) err.textContent = "Veuillez saisir au moins un repas employ√© avec un nom et un choix (Tacos ou Finger Food).";
        repasField.scrollIntoView({behavior:'smooth', block:'center'});
      }else{
        repasField.classList.remove("error");
      }
    });

    /* --------- Envoi Apps Script (adapter l‚ÄôURL si besoin) --------- */
    document.getElementById('passationForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = new FormData(e.target);
      const payload = {};
      for (const [k,v] of data.entries()) payload[k] = v;

      try{
        const res = await fetch('https://script.google.com/macros/s/AKfycbwV6DAltJCzMh3o5Q5dUlyrnq539Al0OrdkJg8-5ZvCn2qUKD2o_2AD69zsX_NaVEyF/exec',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        if(!res.ok) throw new Error('HTTP '+res.status);
        alert('Checklist envoy√©e avec succ√®s !');
      }catch(err){
        console.error(err);
        alert("√âchec de l'envoi. V√©rifiez la connexion ou l'URL du script.");
      }
    }, { once:true });
  </script>
</body>
</html>
