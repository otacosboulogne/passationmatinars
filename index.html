<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CONTR√îLE PASSATION MIDI</title>
  <style>
    :root{
      --ink:#111;
      --muted:#666;
      --line:#1a1a1a;
      --bg:#fff;
      --accent:#000;
      --ok-bg:#e8f5e9;      /* vert tr√®s clair */
      --ok-accent:#2e7d32;  /* vert fonc√© */
      --todo-bg:#ffebee;    /* rouge tr√®s clair */
      --todo-accent:#c62828;/* rouge fonc√© */
      --passation-bg:#e8f5e9;   /* fond vert (comme PDF) */
    }
    html,body{height:100%}
    body{
      font-family: Arial, Helvetica, sans-serif;
      color:var(--ink);
      background:var(--bg);
      margin:0;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
.hidden {
  display: none !important;
}

.success-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.success-card {
  background: #fff;
  border-radius: 12px;
  padding: 24px;
  text-align: center;
  max-width: 400px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

.success-card h3 {
  margin-top: 0;
  font-size: 22px;
}

.success-card button.ok {
  margin-top: 16px;
  background: #111;
  color: #fff;
  border: none;
  border-radius: 6px;
  padding: 10px 18px;
  cursor: pointer;
}
    /* Page avec fond vert */
    .page{
      max-width: 980px;
      margin: 24px auto;
      padding: 24px;
      background: var(--passation-bg);
      border-radius: 10px;
    }

    h1{
      text-align:center;
      letter-spacing: .5px;
      font-size: 24px;
      margin: 0 0 18px;
    }
/* ‚úÖ Boutons radios style "soir" (pastilles visuelles) */
.radio-row {
  display: flex;
  gap: 24px;
  align-items: center;
  flex-wrap: wrap;
  margin-top: 8px;
  margin-bottom: 12px;
}

.radio-option {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-size: 14px;
  color: var(--ink);
  white-space: nowrap;
}

.radio-option input[type="radio"] {
  position: absolute;
  opacity: 0;
  width: 1px;
  height: 1px;
  pointer-events: none;
}

.r-bullet::before {
  content: '‚óã';
  display: inline-block;
  font-size: 16px;
  line-height: 1;
}

.radio-option input[type="radio"]:checked + .r-bullet::before {
  content: '‚óè';
  font-weight: bold;
  color: #1565c0;
}

.r-text {
  margin-left: 4px;
}
    .grid{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }
    @media (max-width: 900px){
      .grid{ grid-template-columns: 1fr; }
    }

    .block{
      background:#fff;
      border: 2px solid var(--line);
      border-radius: 6px;
      padding: 10px 10px 6px;
      page-break-inside: avoid;
    }

    .block h2{
      font-size: 16px;
      margin: 0 0 8px;
      text-transform: uppercase;
      letter-spacing: .5px;
    }

    table.check{
      border-collapse: collapse;
      width: 100%;
      font-size: 13px;
      color: var(--ink);
    }
    table.check th, table.check td{
      border: 1px solid #ccc;
      padding: 6px 8px;
      vertical-align: top;
      background:#fff;
    }
    table.check th{
      background:#f2f2f2;
      font-weight: 700;
      text-align:left;
      color: var(--ink);
    }
    table.check th:nth-child(2),
    table.check th:nth-child(3){ width:72px; text-align:center; }
    table.check td:nth-child(2),
    table.check td:nth-child(3){ text-align:center; }

    .head-todo{ background: var(--todo-bg) !important; color: var(--todo-accent); border-color: var(--todo-accent) !important; }
    .head-ok{ background: var(--ok-bg) !important;   color: var(--ok-accent);   border-color: var(--ok-accent) !important; }

    .is-todo td{ background: var(--todo-bg); }
    .is-ok   td{ background: var(--ok-bg); }

    /* Rouge uniquement sur l'intitul√© (1√®re colonne) des t√¢ches obligatoires */
    .is-required td:first-child,
    .is-required td:first-child *{
      color: var(--todo-accent) !important;
      font-weight: 700;
    }

    .legend{font-size:12px;color:var(--muted);margin:6px 0 0}

    .notes{
      margin-top: 16px;
      border:2px solid var(--line);
      border-radius:6px;
      padding: 10px;
      background:#fff;
    }
    .notes h3{margin:0 0 6px;font-size:14px;text-transform:uppercase}
    .notes textarea{width:100%;min-height:90px;border:1px solid #ccc;border-radius:4px;padding:8px;font-family:inherit;font-size:13px}

    .flex{display:flex;gap:12px;flex-wrap:wrap}
    .flex .field{flex:1 1 220px}
    .field label{display:block;font-size:12px;color:#333;margin:8px 0 4px}
    .field input, .field textarea, .field select{width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;font-size:13px}

    .radio-row{display:flex; gap:16px; align-items:center; flex-wrap:wrap}
    .radio-row label{display:flex; align-items:center; gap:6px; font-size:13px; margin:0}

    .footer{
      display:grid;gap:12px;grid-template-columns: 1fr 1fr; margin-top: 16px;
    }
    @media (max-width: 700px){.footer{grid-template-columns:1fr}}

    .submitbar{display:flex;gap:12px;align-items:center;justify-content:flex-end;margin-top:18px}
    button[type="submit"]{
      background:#111;color:#fff;border:none;border-radius:6px;padding:10px 16px;font-weight:700;cursor:pointer
    }

    /* Bouton reset retir√© */
    button[type="reset"]{display:none !important}

    input[disabled]{opacity:.35; cursor:not-allowed;}

    @media print{
      body{background:#fff}
      .page{margin:0;padding:0;background:#fff}
      .submitbar{display:none}
      a[href]:after{content:""}
    }

/* Repas employ√©s table */
.repas-table{width:100%;border-collapse:collapse;margin-top:8px}
.repas-table th,.repas-table td{border:1px solid var(--line);padding:8px}
.repas-table thead th{background:var(--ok-bg);text-align:left}
.repas-table td.center{text-align:center}
.repas-table input[type="text"]{width:100%;box-sizing:border-box;padding:6px}


/* Validation + radios Repas */
.repas-field .form-error{margin-top:6px;font-size:0.95rem;color:#c62828;display:none}
.repas-field.error .form-error{display:block}
.repas-field.error .repas-table{outline:2px solid #c62828;outline-offset:2px}
.repas-table input[type="radio"]{width:18px;height:18px}


/* Repas employ√©s - layout */
.repas-field label{font-weight:600;margin-bottom:6px;display:block}
.repas-table{width:100%;border-collapse:collapse;margin-top:6px;table-layout:fixed}
.repas-table th,.repas-table td{border:1px solid var(--line);padding:8px;vertical-align:middle;background:#fff}
.repas-table thead th{background:var(--ok-bg);text-align:left}
.repas-table td.center{text-align:center}
.repas-table input[type="text"]{width:100%;box-sizing:border-box;padding:8px;height:36px}
.repas-table input[type="radio"]{width:18px;height:18px}

    table, .block, .repas-table {
  page-break-inside: avoid;
}

</style>
</head>
<body>
  <div class="page">
     <h1>CONTR√îLE PASSATION MIDI</h1>

    <form id="passationForm">
      <div class="grid" id="sections"></div>

      <div class="notes">
        <h3>Commentaires & informations</h3>
        <div class="flex">
          <div class="field" style="flex:1 1 100%">
            <label for="commentaires">Commentaires et informations diverses (Information importante / personnel / incident caisse / technique)</label>
            <textarea id="commentaires" name="commentaires" placeholder="Saisir ici..."></textarea>
          </div>
          <div class="field" style="flex:1 1 100%">
            <label for="ruptures">Pr√©ciser ici les prochaines ruptures</label>
            <textarea id="ruptures" name="ruptures" placeholder="Produits √† risque de rupture, quantit√©s restantes, etc..."></textarea>
          </div>
        </div>
      </div>

      <div class="footer">
        <div class="block">
          <h2>Informations importantes</h2>
          <div class="flex">
              <label for="nombrePertesConception">Nombre de pertes de conception en cuisine durant ton service</label>
<input id="nombrePertesConception" name="nombrePertesConception"
       type="number" inputmode="numeric" min="0" step="1" placeholder="0" required />
              <div id="detailPertesConception" class="field" style="display:none;">
  <label for="detailsPertesConception">D√©tail des pertes de conception</label>
  <textarea id="detailsPertesConception" name="detailsPertesConception" placeholder="Pr√©cisez les produits ou erreurs..."></textarea>
</div>
            </div>
            <div class="field">
              
<div id="repas-employes" class="field repas-field" style="flex:1 1 420px;min-width:360px">
  <label>Repas employ√©s</label>
  <table class="repas-table" aria-label="Repas employ√©s">
    <colgroup>
      <col style="width:50%">
      <col style="width:15%">
      <col style="width:15%">
      <col style="width:20%">
    </colgroup>
    <thead>
      <tr>
        <th>Nom du salari√©</th>
        <th>Tacos</th>
        <th>Finger Food</th>
        <th>Supprimer</th>
      </tr>
    </thead>
    <tbody id="repas-body">
      <tr>
        <td><input type="text" name="employe_nom_1" placeholder="Nom et pr√©nom" aria-label="Nom du salari√© 1"></td>
        <td class="center"><input type="radio" name="employe_1_repas" value="tacos" aria-label="Tacos"></td>
        <td class="center"><input type="radio" name="employe_1_repas" value="finger" aria-label="Finger Food"></td>
        <td class="center"><button type="button" class="remove-row" style="background:#c62828;color:#fff;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;">üóëÔ∏è</button></td>
      </tr>
    </tbody>
  </table>
  <button type="button" id="add-repas" style="margin-top:8px;background:#1565c0;color:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;">
    + Ajouter un repas
  </button>
  <p class="form-error" aria-live="polite"></p>
</div>


<label>Pertes jet√©es √† la poubelle</label>
              <div class="radio-row" role="radiogroup" aria-label="Pertes jet√©es">
                <label class="radio-option">
                  <input type="radio" name="Pertesjetees" value="Oui" required>
                  <span class="r-bullet" aria-hidden="true"></span><span class="r-text">Oui</span>
                </label>
                <label class="radio-option">
                  <input type="radio" name="Pertesjetees" value="Non">
                  <span class="r-bullet" aria-hidden="true"></span><span class="r-text">Non</span>
                </label>
              </div>
            </div>
            <div class="field" style="flex:1 1 280px">
              <label>les pertes saisies sur le t√©l√©phone</label>
              <div class="radio-row" role="radiogroup" aria-label="pertes saisies">
                <label class="radio-option">
                  <input type="radio" name="pertessaisies" value="Oui" required>
                  <span class="r-bullet" aria-hidden="true"></span><span class="r-text">Oui</span>
                </label>
                <label class="radio-option">
                  <input type="radio" name="pertessaisies" value="Non">
                  <span class="r-bullet" aria-hidden="true"></span><span class="r-text">Non</span>
                </label>
              </div>
            </div>
          </div>
        </div>
        
        <div class="block">
          <h2>Informations de passation</h2>
          <div class="flex">
            <div class="field"><label for="date">Date</label><input id="date" name="date" type="date" required /></div>
            <div class="field"><label for="heure">Heure</label><input id="heure" name="heure" type="time" required /></div>
            <div class="field" style="flex:1 1 280px"><label for="respUnique">Nom du responsable</label><input id="respUnique" name="responsable" type="text" required /></div>
          </div>
        </div>
      </div>

      <div class="submitbar">
        <button type="submit">Envoyer la checklist</button>
      </div>
    </form>

    <div id="formMessageContainer"></div>
  </div>

  <!-- Grand message de succ√®s -->
  <div id="successOverlay" class="success-overlay hidden" role="dialog" aria-modal="true">
    <div class="success-card">
      <h3 id="successTitle">Merci !</h3>
      <p id="successDetails">La passation est enregistr√©e.</p>
      <button class="ok" onclick="document.getElementById('successOverlay').classList.add('hidden')">OK</button>
    </div>
  </div>

  <!-- Sections dynamiques -->
  <script>
    const SECTIONS = [
      { title: "Terrasse", tasks: [
        "Sol, tables, chaises",
        "Poubelle",
        "Cendriers vides et disponibles"
      ]},
      { title: "Toilettes Clients", tasks: [
        "Papier / savon",
        "Toilettes (cuvette, lunette, rebords)",
        "Odeur",
        "Miroir",
        "Poubelle propre et non pleine",
        "S√®che-mains propre et fonctionnel"
      ]},
      { title: "Cuisine", tasks: [
        "Viandes et suppl√©ments en suffisance",
        "Sauces en suffisance",
        "Frigo rempli",
        "Essuie-mains, savon en suffisance",
        "Poubelles chang√©es",
        "Tra√ßabilit√© prise",
        "Pertes comptabilis√©es",
        "Galettes descendues",
        "Rouleaux de papier dans imprimantes",
        "Huile √† niveau dans les friteuses",
        "Eau √† niveau dans bain-marie",
        "Friteuses filtr√©es",
        "Filtre friteuse chang√©",
        "Emballages en suffisance",
        "Sol et surfaces propres",
      ]},
      { title: "Chambre froide et Frigos", tasks: [
        "D√©cong√©lations pr√©par√©es",
        "Sauces en double dans meuble froid",
        "Caillebotis propres",
        "√âtag√®res propres",
        "Produits remont√©s / rotation faite Ch- et frigos",
        "Frigo 2 prtes et Frigo 1 porte propre (int/ext)"
      ]},
      { title: "Salle", tasks: [
        "Sol propre",
        "Tables, pieds de tables, chaises propres",
        "Poubelles propres et non pleines",
        "Musique en marche",
        "Bornes fonctionnelles"
      ]},
      { title: "Comptoir", tasks: [
        "Frigos √† boissons remplis",
        "Comptoir desserts rempli",
        "Toppings, nappages, lait en suffisance",
        "T√©l√©commandes, agrafeuse, et t√©l√©phone disponibles",
        "DLC contr√¥l√©es, signalement si besoin",
        "Meuble O‚Äôsucr√© propre et rang√©",
        "Comptoir propre et rang√©",
        "Pr√©sence pailles/serviettes/gobelets/emballages",
        "Plateaux propres et dress√©s",
        "Machine √† glace propre",
        "Vaisselle propre",
        "Savon, essuie-mains en suffisance",
        "Produits d‚Äôentretien en suffisance",
        "Rouleaux pleins dans imprimantes et TPE",
        "Caisse compt√©e + celle de l'√©quipier + fond de caisse fait si Glory en panne",
        "Monnaie suffisante dans monnayeur (pr√©venir dans le groupe manager sinon)",
        "Disponibilit√© produits en caisse / Borne / Uber (d√®s r√©ception apr√®s rupture)"
      ]},
      { title: "R√©serves", tasks: [
        "R√©serve bien rang√©e",
        "Sol et √©tag√®res propres",
        "FIFO / DLC"
      
      ]},
      { title: "√âtage", tasks: [
        "Sol propre",
        "Toilettes, lavabos, murs propres",
        "Savon, essuie-mains en suffisance",
        "Poubelles non pleines"
      ]},
      { title: "Plonge", tasks: [
        "Plonge termin√©e",
        "Zone et mat√©riel propres",
        "Produits diluer et en suffisance"
      ]},
      { title: "E-Pack Hygi√®ne", tasks: [
        "Nettoyage des postes rempli",
        "Check-list manager remplie"
      ]},
      { title: "Tenue du personnel", tasks: [
        "Compl√®te, propre, repass√©e",
        "Cheveux attach√©s",
        "Pas de bijoux sauf alliance",
        "Charlotte, tablier, sur-chaussures en cuisine"
      ]}
    ];

    // T√¢ches obligatoires = OK uniquement + libell√© rouge
    const OK_ONLY = new Map([
      ["Cuisine", new Set([
        "Viandes et suppl√©ments en suffisance",
        "Sauces en suffisance",
        "Essuie-mains, savon en suffisance",
        "Galettes descendues",
        "Rouleaux de papier dans imprimantes",
        "Huile √† niveau dans les friteuses",
        "Eau √† niveau dans bain-marie",
        "Emballages en suffisance"
      ])],
      ["Salle", new Set([
        "Bornes fonctionnelles"
      ])],
      ["R√©serves", new Set([
        "FIFO / DLC"   // << obligatoire: rouge + "√Ä faire" d√©sactiv√©
      ])],
      ["Plonge", new Set([
        "Produits diluer et en suffisance"
      ])],
      ["Toilettes Clients", new Set([
        "Papier / savon"
      ])],
      ["Chambre froide et frigos", new Set([
        "D√©cong√©lations pr√©par√©es",
        "Produits remont√©s / rotation faite Ch- et frigos"
      ])],
      ["Comptoir", new Set([
        "Frigos √† boissons remplis",
        "Comptoir desserts rempli",
        "Toppings, nappages, lait en suffisance",
        "DLC contr√¥l√©es, signalement si besoin",
        "Plateaux propres et dress√©s",
        "Rouleaux pleins dans imprimantes et TPE",
        "Caisse compt√©e + celle de l'√©quipier + fond de caisse fait si Glory en panne",
        "Disponibilit√© produits en caisse / Borne / Uber (d√®s r√©ception apr√®s rupture)"
      ])],
      ["E-Pack Hygi√®ne", new Set([
        "Nettoyage des postes rempli",
        "Check-list manager remplie"
      ])],
      ["Tenue du personnel", new Set([
        "Charlotte, tablier, sur-chaussures en cuisine"
      ])]
    ]);

    function isOkOnly(sectionTitle, taskText){
      return OK_ONLY.has(sectionTitle) && OK_ONLY.get(sectionTitle).has(taskText);
    }

    const sectionsRoot = document.getElementById('sections');

    function buildStandardBlock(section){
      const block = document.createElement('section'); block.className='block';
      const h = document.createElement('h2'); h.textContent = section.title.toUpperCase();

      const table = document.createElement('table'); table.className='check';
      const thead = document.createElement('thead');
      thead.innerHTML = `<tr>
        <th>T√¢che</th>
        <th class="head-todo">√Ä FAIRE</th>
        <th class="head-ok">OK</th>
      </tr>`;
      const tbody = document.createElement('tbody');

      section.tasks.forEach((task, tIdx) => {
        const id = `${section.title.replace(/[^a-z0-9]/gi,'_').toLowerCase()}_${tIdx}`;
        const onlyOk = isOkOnly(section.title, task);

        const tr = document.createElement('tr');
        if (onlyOk) tr.classList.add('is-required');

        tr.innerHTML = `
          <td>${task}</td>
          <td>${
            onlyOk
              ? `<label class="radio-option" title="Non disponible pour cette t√¢che">
                   <input type="radio" disabled>
                   <span class="r-bullet" aria-hidden="true"></span>
                 </label>`
              : `<label class="radio-option">
                   <input type="radio" name="${id}" value="A faire" aria-label="${task} - √Ä faire">
                   <span class="r-bullet" aria-hidden="true"></span>
                 </label>`
          }</td>
          <td>
            <label class="radio-option">
              <input type="radio" name="${id}" value="OK" aria-label="${task} - OK">
              <span class="r-bullet" aria-hidden="true"></span>
            </label>
          </td>
        `;

        tr.addEventListener('change', (e) => {
          if(e.target.name === id){
            tr.classList.remove('is-todo','is-ok');
            if(e.target.value === 'A faire') tr.classList.add('is-todo');
            if(e.target.value === 'OK')      tr.classList.add('is-ok');
          }
        });

        tbody.appendChild(tr);
      });

      table.appendChild(thead); table.appendChild(tbody);
      block.appendChild(h); block.appendChild(table);
      return block;
    }

    function buildObjectifBlock(){
      const block = document.createElement('section'); block.className='block';
      const h = document.createElement('h2'); h.textContent = 'OBJECTIF';

      const table = document.createElement('table'); table.className='check';
      const thead = document.createElement('thead');
      thead.innerHTML = `<tr><th>√âl√©ment</th><th class="head-ok">Oui</th><th class="head-todo">Non</th></tr>`;
      const tbody = document.createElement('tbody');

      [
        { label: "Objectif avis Google donn√© au salari√© en caisse", name: "objectifAvisGoogle" },
        { label: "Briefing et d√©briefing effectu√©s", name: "briefingDebriefing" },
        { label: "Satisfait du service et temps d'attente", name: "satisfaitService" },
        { label: "effectif suffissant pour le service", name: "satisfaiteffectif" },
      ].forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.label}</td>
          <td><label class="radio-option"><input type="radio" name="${r.name}" value="Oui" aria-label="${r.label} - Oui"><span class="r-bullet" aria-hidden="true"></span></label></td>
          <td><label class="radio-option"><input type="radio" name="${r.name}" value="Non" aria-label="${r.label} - Non"><span class="r-bullet" aria-hidden="true"></span></label></td>`;
        tbody.appendChild(tr);
      });

      table.appendChild(thead); table.appendChild(tbody);
      block.appendChild(h); block.appendChild(table);
      return block;
    }

    // G√©n√®re les sections + ins√®re OBJECTIF apr√®s "E-Pack Hygi√®ne"
    SECTIONS.forEach((section) => {
      const block = buildStandardBlock(section);
      sectionsRoot.appendChild(block);
      if (section.title === "E-Pack Hygi√®ne") sectionsRoot.appendChild(buildObjectifBlock());
    });
  </script>

  
<script>
(function(){
  var form = document.getElementById('passationForm');
  var repas = document.getElementById('repas-employes');
  function validateRepas(){
    if (!repas) return true;
    var anyChecked = repas.querySelector('input[type="radio"]:checked');
    if (!anyChecked){
      repas.classList.add('error');
      var err = repas.querySelector('.form-error');
      if (err){ err.textContent = '√ätes-vous s√ªr qu‚Äôaucun salari√© n‚Äôa pris de repas ? Si oui, mettez √† la place du nom "PERSONNE" PUIS COCHER TACOS'; }
      return false;
    }
    repas.classList.remove('error');
    return true;
  }
  if (form){
    // Submit CAPTURE phase to run before other listeners
    form.addEventListener('submit', function(e){
      if (!validateRepas()){
        e.preventDefault();
        e.stopImmediatePropagation();
        repas.scrollIntoView({behavior:'smooth', block:'center'});
      }
    }, true);
  }
})();
</script>

  <!-- libs PDF (s√©par√©es pour iOS, √©vite l‚Äôerreur "color") -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.min.js"></script>

<!-- ‚úÖ Envoi du formulaire (version robuste) -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbz9HRK0glIiN6DJupasx6meANOqPAAJ5A-NEYUeWRjgHiFBKJ7Pf_cwka5reQ-V7mzl/exec";
  const form = document.getElementById("passationForm");
  if (!form) { console.error("‚ö†Ô∏è Formulaire introuvable !"); return; }

  let formAlreadySent = false;

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    if (formAlreadySent) return;

    // üîé R√©cup√®re le bouton **au moment du submit**
    // - e.submitter : bouton r√©ellement cliqu√© (standard)
    // - fallbacks : si submit par la touche Entr√©e ou si structure diff√©rente
    const btn =
      e.submitter ||
      form.querySelector('button[type="submit"], input[type="submit"]') ||
      document.querySelector(".submitbar button[type='submit']");

    // R√©cup√®re la barre d‚Äôenvoi si pr√©sente (s√©curis√©)
    const submitbar = document.querySelector(".submitbar");

    const meta = {
      date: form.date?.value || "",
      heure: form.heure?.value || "",
      responsable: (form.respUnique?.value || form.responsable?.value || "").trim(),
      ruptures: (form.ruptures?.value || "").trim(),
    };

    // üîí Emp√™cher double envoi (m√™me jour + m√™me responsable)
    const key = `passation-${meta.date}-${meta.responsable.toLowerCase()}`;
    if (localStorage.getItem(key)) {
      alert("‚ö†Ô∏è Une checklist a d√©j√† √©t√© envoy√©e aujourd‚Äôhui par ce responsable.");
      if (btn) {
        btn.disabled = false;
        btn.textContent = "Checklist d√©j√† envoy√©e";
        btn.style.opacity = "1";
        btn.style.cursor = "pointer";
      }
      return;
    }

    // üîí D√©sactive le bouton pendant l‚Äôenvoi (si trouv√©)
    if (btn) {
      btn.disabled = true;
      btn.textContent = "‚è≥ Envoi en cours...";
      btn.style.opacity = "0.6";
      btn.style.cursor = "not-allowed";
    } else {
      console.warn("‚ö†Ô∏è Bouton Envoyer introuvable ‚Äì on continue sans animation du bouton.");
    }

    // Masque la barre d‚Äôenvoi pour le rendu PDF si pr√©sente
    const page = document.querySelector(".page");
    const prevDisplay = submitbar ? submitbar.style.display : "";
    if (submitbar) submitbar.style.display = "none";

    try {
      const pdfBlob = await makePdfBlob(page);
      if (submitbar) submitbar.style.display = prevDisplay;

      const b64 = await blobToBase64(pdfBlob);
      const body = new URLSearchParams({ data: JSON.stringify({ b64, meta }) });

      const res = await fetch(WEBAPP_URL, { method: "POST", body });
      const txt = await res.text();
      if (!res.ok) throw new Error("HTTP " + res.status + " : " + txt);

      const json = JSON.parse(txt);
      if (json.status !== "ok") throw new Error(json.message || "Erreur serveur");

      // ‚úÖ Succ√®s
      formAlreadySent = true;
      localStorage.setItem(key, "1");
      if (btn) {
        btn.textContent = "‚úÖ Checklist envoy√©e";
        btn.style.background = "#2e7d32";
        btn.style.opacity = "1";
        btn.style.cursor = "not-allowed";
      }

      const title = document.getElementById("successTitle");
      const details = document.getElementById("successDetails");
      if (title) title.textContent = `Merci ${meta.responsable || ""} !`;
      if (details) details.textContent = "La passation a bien √©t√© enregistr√©e.";
      const overlay = document.getElementById("successOverlay");
      if (overlay) overlay.classList.remove("hidden");

    } catch (err) {
      console.error(err);
      showMessage("‚ùå √âchec de l‚Äôenvoi : " + err.message, "error", true);
      if (btn) {
        btn.disabled = false;
        btn.textContent = "R√©essayer l‚Äôenvoi";
        btn.style.opacity = "1";
        btn.style.cursor = "pointer";
      }
      if (submitbar) submitbar.style.display = prevDisplay;
    }
  });

  // üîÑ Convertit le PDF en base64
  function blobToBase64(blob) {
    return new Promise((resolve) => {
      const r = new FileReader();
      r.onloadend = () => resolve(r.result.split(",")[1]);
      r.readAsDataURL(blob);
    });
  }
<script>
// üìÑ G√©n√©ration du PDF en conservant les couleurs (sRGB) tout en √©vitant l'erreur color()
async function makePdfBlob(page) {
  const opt = {
    margin: [5, 10, 10, 10],
    jsPDF: { unit: "mm", format: "a4", orientation: "portrait" },
    html2canvas: {
      scale: 2,
      scrollY: 0,
      onclone: (clonedDoc) => {
        // 1) Cacher la barre d'envoi dans le clone
        const sb = clonedDoc.querySelector(".submitbar");
        if (sb) sb.style.display = "none";

        // 2) Styles "safe" MINIMAUX : on enl√®ve uniquement ce qui casse (gradients/ombres),
        //    puis on remet une palette sRGB lisible pour les √©l√©ments principaux.
        const style = clonedDoc.createElement("style");
        style.id = "h2c-safe-min";
        style.textContent = `
          /* --- Neutralisation des choses risqu√©es --- */
          * { text-shadow: none !important; box-shadow: none !important; }
          * { background-image: none !important; } /* √©vite color() dans gradients */

          /* --- Palette sRGB "OT" : vert / rouge / gris --- */
          .page { background: #ffffff !important; }
          .section, .card, fieldset {
            background: #eef8ee !important;           /* vert tr√®s clair */
            border: 2px solid #2e7d32 !important;     /* vert sRGB */
          }
          .field { border-color: #2e7d32 !important; }
          .form-error, .error { color: #c62828 !important; }   /* rouge erreurs */
          .success { color: #2e7d32 !important; }               /* vert succ√®s */

          /* Boutons d'action */
          .submitbar button[type="submit"],
          button[type="submit"],
          input[type="submit"] {
            background: #2e7d32 !important;
            color: #ffffff !important;
            border: 1px solid #1b5e20 !important;
          }

          /* Bordures g√©n√©rales pour tableaux/champs */
          table, th, td, input, textarea, select {
            border-color: #9e9e9e !important;
          }
        `;
        clonedDoc.head.appendChild(style);

        // 3) S√©curit√© additionnelle : s'il reste des backgrounds "gradient(...)",
        //    on les coupe (certains navigateurs ne r√©solvent pas en sRGB).
        clonedDoc.querySelectorAll("*").forEach((el) => {
          const s = clonedDoc.defaultView.getComputedStyle(el);
          if (s.backgroundImage && s.backgroundImage !== "none") {
            el.style.backgroundImage = "none";
          }
        });
      },
    },
    pagebreak: { mode: ["avoid-all", "css", "legacy"] },
  };

  return await html2pdf().set(opt).from(page).output("blob");
}
</script>
  // üí¨ Message d‚Äôerreur / succ√®s
  function showMessage(text, type, withRetry) {
    const c = document.getElementById("formMessageContainer");
    if (!c) return;
    c.innerHTML = "";
    const m = document.createElement("div");
    m.className = "form-message " + (type === "success" ? "success" : "error");
    m.textContent = text;
    if (withRetry) {
      const b = document.createElement("button");
      b.type = "button";
      b.className = "retry";
      b.textContent = "R√©essayer";
      b.onclick = () => {
        const submitBtn =
          document.querySelector(".submitbar button[type='submit']") ||
          document.querySelector("button[type='submit']");
        submitBtn?.click();
      };
      m.appendChild(b);
    }
    c.appendChild(m);
  }
});
</script>
<!-- ‚úÖ Gestion du tableau des repas -->
<!-- Scripts de la page -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  // ====== Repas employ√©s (ajout/suppression + validation) ======
  const form = document.getElementById("passationForm");
  const repasBody = document.getElementById("repas-body");
  const addBtn = document.getElementById("add-repas");
  const repasField = document.getElementById("repas-employes");

  // si une ligne existe d√©j√†, on part de cette quantit√©
  let count = repasBody ? Math.max(1, repasBody.querySelectorAll("tr").length) : 1;

  if (repasBody && addBtn) {
    addBtn.addEventListener("click", () => {
      count++;
      const row = document.createElement("tr");
      row.innerHTML = `
        <td><input type="text" name="employe_nom_${count}" placeholder="Nom et pr√©nom" aria-label="Nom du salari√© ${count}"></td>
        <td class="center"><input type="radio" name="employe_${count}_repas" value="tacos"></td>
        <td class="center"><input type="radio" name="employe_${count}_repas" value="finger"></td>
        <td class="center"><button type="button" class="remove-row" style="background:#c62828;color:#fff;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;">üóëÔ∏è</button></td>
      `;
      repasBody.appendChild(row);
    });

    repasBody.addEventListener("click", (e) => {
      if (e.target.classList.contains("remove-row")) {
        const row = e.target.closest("tr");
        if (repasBody.querySelectorAll("tr").length > 1) {
          row.remove();
        } else {
          alert("Il doit rester au moins une ligne !");
        }
      }
    });
  }

  if (form && repasBody && repasField) {
    form.addEventListener("submit", (e) => {
      const rows = repasBody.querySelectorAll("tr");
      let valid = false;

      for (const row of rows) {
        const nom = row.querySelector('input[type="text"]')?.value.trim() || "";
        const checked = row.querySelector('input[type="radio"]:checked');
        if (nom !== "" && checked) {
          valid = true;
          break;
        }
      }

      if (!valid) {
        e.preventDefault();
        repasField.classList.add("error");
        const err = repasField.querySelector(".form-error");
        if (err) {
          err.textContent = "Veuillez saisir au moins un repas employ√© avec un nom et un choix (Tacos ou Finger Food).";
        }
        repasField.scrollIntoView({ behavior: "smooth", block: "center" });
      } else {
        repasField.classList.remove("error");
      }
    }, true);
  }

  // ====== Pertes de conception (afficher/masquer le d√©tail) ======
  const pertesInput = document.getElementById("nombrePertesConception");
  const detailField = document.getElementById("detailPertesConception");
  const detailTextarea = document.getElementById("detailsPertesConception");

  const syncPertes = () => {
    const value = parseInt(pertesInput.value, 10);
    if (!isNaN(value) && value > 0) {
      detailField.style.display = "block";
      detailTextarea.setAttribute("required", "required");
    } else {
      detailField.style.display = "none";
      detailTextarea.removeAttribute("required");
      detailTextarea.value = "";
    }
  };

  if (pertesInput && detailField && detailTextarea) {
    pertesInput.addEventListener("input", syncPertes);
    syncPertes(); // √©tat correct d√®s le chargement
  }
});
</script>
</body>
</html>
